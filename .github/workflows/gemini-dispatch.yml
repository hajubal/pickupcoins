name: 'ðŸ”€ Gemini Dispatch'

on:
  pull_request_review_comment:
    types:
      - 'created'
  pull_request_review:
    types:
      - 'submitted'
  pull_request:
    types:
      - 'opened'
  issue_comment:
    types:
      - 'created'

defaults:
  run:
    shell: 'bash'

jobs:
  dispatch:
    # For PRs: only if not from a fork (security)
    # For comments: only if user types @gemini-cli and is OWNER/MEMBER/COLLABORATOR
    if: |-
      (
        github.event_name == 'pull_request' &&
        github.event.pull_request.head.repo.fork == false
      ) || (
        github.event.sender.type == 'User' &&
        startsWith(github.event.comment.body || github.event.review.body || '', '@gemini-cli') &&
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association || github.event.review.author_association)
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    outputs:
      command: ${{ steps.extract_command.outputs.command }}
      additional_context: ${{ steps.extract_command.outputs.additional_context }}
      pull_request_number: ${{ github.event.pull_request.number || github.event.issue.number }}
      issue_title: ${{ github.event.pull_request.title || github.event.issue.title }}
      issue_body: ${{ github.event.pull_request.body || github.event.issue.body }}
      repository: ${{ github.repository }}
    steps:
      - name: 'Extract command'
        id: extract_command
        uses: actions/github-script@v7
        with:
          script: |
            const eventType = process.env.EVENT_TYPE;
            const request = (process.env.REQUEST || '');
            core.setOutput('request', request);
            if (eventType === 'pull_request.opened') {
              core.setOutput('command', 'review');
            } else if (request.startsWith('@gemini-cli /review')) {
              core.setOutput('command', 'review');
              const additionalContext = request.replace(/^@gemini-cli \/review/, '').trim();
              core.setOutput('additional_context', additionalContext);
            } else if (request.startsWith('@gemini-cli')) {
              core.setOutput('command', 'fallthrough');
            } else {
              core.setOutput('command', 'fallthrough');
            }
        env:
          EVENT_TYPE: ${{ github.event_name }}.${{ github.event.action }}
          REQUEST: ${{ github.event.comment.body || github.event.review.body || '' }}

      - name: 'Acknowledge request'
        if: steps.extract_command.outputs.command == 'review'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
          MESSAGE: |
            ðŸ¤– Hi @${{ github.actor }}, I've received your request, and I'm working on it now! You can track my progress [in the logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
          REPOSITORY: ${{ github.repository }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "${MESSAGE}" \
            --repo "${REPOSITORY}"

  review:
    needs: dispatch
    if: ${{ needs.dispatch.outputs.command == 'review' }}
    uses: ./.github/workflows/gemini-review.yml
    permissions:
      contents: read
      id-token: write
      issues: write
      pull-requests: write
    with:
      additional_context: ${{ needs.dispatch.outputs.additional_context }}
      pull_request_number: ${{ needs.dispatch.outputs.pull_request_number }}
      issue_title: ${{ needs.dispatch.outputs.issue_title }}
      issue_body: ${{ needs.dispatch.outputs.issue_body }}
      repository: ${{ needs.dispatch.outputs.repository }}
    secrets: inherit

  fallthrough:
    needs: [dispatch, review]
    if: ${{ always() && !cancelled() && (failure() || (needs.review.result == 'skipped' && needs.dispatch.outputs.command == 'fallthrough')) }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: 'Send failure or fallthrough comment'
        if: failure() || needs.dispatch.outputs.command == 'fallthrough'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
          MESSAGE: |
            ðŸ¤– I'm sorry @${{ github.actor }}, but I was unable to process your request. Please [see the logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
          REPOSITORY: ${{ github.repository }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "${MESSAGE}" \
            --repo "${REPOSITORY}"
