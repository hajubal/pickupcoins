generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enum for Point URL types
enum PointUrlType {
  NAVER
  OFW_NAVER
  UNSUPPORT
}

// Site model - stores crawling site information
model Site {
  id           BigInt    @id @default(autoincrement())
  name         String    @db.VarChar(255)
  domain       String    @db.VarChar(255)
  url          String    @db.VarChar(255)
  createdDate  DateTime  @default(now()) @map("created_date")
  modifiedDate DateTime  @updatedAt @map("modified_date")
  createdBy    String?   @map("created_by") @db.VarChar(255)
  lastModifiedBy String? @map("last_modified_by") @db.VarChar(255)

  @@map("site")
}

// SiteUser model - admin user accounts
model SiteUser {
  id              BigInt    @id @default(autoincrement())
  loginId         String    @unique @map("login_id") @db.VarChar(100)
  userName        String    @map("user_name") @db.VarChar(255)
  password        String    @db.VarChar(1024)
  slackWebhookUrl String?   @map("slack_webhook_url") @db.VarChar(255)
  active          Boolean   @default(true)
  createdDate     DateTime  @default(now()) @map("created_date")
  modifiedDate    DateTime  @updatedAt @map("modified_date")
  createdBy       String?   @map("created_by") @db.VarChar(255)
  lastModifiedBy  String?   @map("last_modified_by") @db.VarChar(255)

  cookies         Cookie[]

  @@map("site_user")
}

// Cookie model - user session cookies for point sites
model Cookie {
  id           BigInt    @id @default(autoincrement())
  userName     String    @map("user_name") @db.VarChar(255)
  siteName     String    @map("site_name") @db.VarChar(255)
  cookie       String?   @db.Text
  isValid      Boolean   @default(true) @map("is_valid")
  siteUserId   BigInt    @map("site_user_id")
  createdDate  DateTime  @default(now()) @map("created_date")
  modifiedDate DateTime  @updatedAt @map("modified_date")
  createdBy    String?   @map("created_by") @db.VarChar(255)
  lastModifiedBy String? @map("last_modified_by") @db.VarChar(255)

  siteUser        SiteUser         @relation(fields: [siteUserId], references: [id])
  pointUrlCookies PointUrlCookie[]
  savedPoints     SavedPoint[]

  @@index([siteName, isValid], map: "idx_cookie_site_valid")
  @@index([siteUserId], map: "idx_cookie_site_user")
  @@map("cookie")
}

// PointUrl model - point earning URLs found via crawling
model PointUrl {
  id           BigInt       @id @default(autoincrement())
  name         String       @db.VarChar(255)
  url          String       @db.VarChar(2048)
  pointUrlType PointUrlType? @map("point_url_type")
  permanent    Boolean      @default(false)
  createdDate  DateTime     @default(now()) @map("created_date")
  modifiedDate DateTime     @updatedAt @map("modified_date")
  createdBy    String?      @map("created_by") @db.VarChar(255)
  lastModifiedBy String?    @map("last_modified_by") @db.VarChar(255)

  pointUrlCookies PointUrlCookie[]

  @@index([name, permanent], map: "idx_point_url_name_permanent")
  @@index([createdDate], map: "idx_point_url_created")
  @@map("point_url")
}

// PointUrlCookie model - junction table between PointUrl and Cookie
model PointUrlCookie {
  id           BigInt    @id @default(autoincrement())
  pointUrlId   BigInt    @map("point_url_id")
  cookieId     BigInt    @map("cookie_id")
  createdDate  DateTime  @default(now()) @map("created_date")
  modifiedDate DateTime  @updatedAt @map("modified_date")
  createdBy    String?   @map("created_by") @db.VarChar(255)
  lastModifiedBy String? @map("last_modified_by") @db.VarChar(255)

  pointUrl     PointUrl  @relation(fields: [pointUrlId], references: [id])
  cookie       Cookie    @relation(fields: [cookieId], references: [id], onDelete: Cascade)

  @@unique([pointUrlId, cookieId])
  @@map("point_url_cookie")
}

// PointUrlCallLog model - logs of point URL invocations
model PointUrlCallLog {
  id                 BigInt    @id @default(autoincrement())
  pointUrl           String    @map("point_url") @db.VarChar(2048)
  siteName           String    @map("site_name") @db.VarChar(255)
  userName           String    @map("user_name") @db.VarChar(255)
  responseBody       String?   @map("response_body") @db.Text
  responseHeader     String?   @map("response_header") @db.Text
  cookie             String?   @db.Text
  responseStatusCode Int       @map("response_status_code")
  createdDate        DateTime  @default(now()) @map("created_date")
  modifiedDate       DateTime  @updatedAt @map("modified_date")
  createdBy          String?   @map("created_by") @db.VarChar(255)
  lastModifiedBy     String?   @map("last_modified_by") @db.VarChar(255)

  @@map("point_url_call_log")
}

// SavedPoint model - records of successfully earned points
model SavedPoint {
  id           BigInt    @id @default(autoincrement())
  cookieId     BigInt    @map("cookie_id")
  amount       Int
  responseBody String?   @map("response_body") @db.MediumText
  createdDate  DateTime  @default(now()) @map("created_date")
  modifiedDate DateTime  @updatedAt @map("modified_date")
  createdBy    String?   @map("created_by") @db.VarChar(255)
  lastModifiedBy String? @map("last_modified_by") @db.VarChar(255)

  cookie       Cookie    @relation(fields: [cookieId], references: [id], onDelete: Cascade)

  @@index([createdDate], map: "idx_saved_point_created")
  @@map("saved_point")
}
