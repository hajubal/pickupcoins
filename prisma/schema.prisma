generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Site model - stores crawling site information
model Site {
  id            Int       @id @default(autoincrement())
  name          String
  url           String
  createdDate   DateTime  @default(now()) @map("created_date")
  modifiedDate  DateTime  @updatedAt @map("modified_date")
  createdBy     String?   @map("created_by")
  lastModifiedBy String?  @map("last_modified_by")

  @@map("site")
}

// SiteUser model - admin user accounts
model SiteUser {
  id              Int       @id @default(autoincrement())
  loginId         String    @unique @map("login_id")
  userName        String    @map("user_name")
  password        String
  slackWebhookUrl String?   @map("slack_webhook_url")
  active          Boolean   @default(true)
  createdDate     DateTime  @default(now()) @map("created_date")
  modifiedDate    DateTime  @updatedAt @map("modified_date")
  createdBy       String?   @map("created_by")
  lastModifiedBy  String?   @map("last_modified_by")

  cookies Cookie[]

  @@map("site_user")
}

// Cookie model - user session cookies for point sites
model Cookie {
  id             Int       @id @default(autoincrement())
  userName       String    @map("user_name")
  siteName       String    @map("site_name")
  cookie         String?
  isValid        Boolean   @default(true) @map("is_valid")
  siteUserId     Int       @map("site_user_id")
  createdDate    DateTime  @default(now()) @map("created_date")
  modifiedDate   DateTime  @updatedAt @map("modified_date")
  createdBy      String?   @map("created_by")
  lastModifiedBy String?   @map("last_modified_by")

  siteUser        SiteUser         @relation(fields: [siteUserId], references: [id])
  pointUrlCookies PointUrlCookie[]
  savedPoints     SavedPoint[]

  @@index([siteName, isValid], map: "idx_cookie_site_valid")
  @@index([siteUserId], map: "idx_cookie_site_user")
  @@map("cookie")
}

// PointUrl model - point earning URLs found via crawling
model PointUrl {
  id             Int          @id @default(autoincrement())
  name           String
  url            String
  pointUrlType   String?       @map("point_url_type") // NAVER | OFW_NAVER | UNSUPPORT
  permanent      Boolean      @default(false)
  createdDate    DateTime     @default(now()) @map("created_date")
  modifiedDate   DateTime     @updatedAt @map("modified_date")
  createdBy      String?      @map("created_by")
  lastModifiedBy String?      @map("last_modified_by")

  pointUrlCookies PointUrlCookie[]

  @@index([name, permanent], map: "idx_point_url_name_permanent")
  @@index([createdDate], map: "idx_point_url_created")
  @@map("point_url")
}

// PointUrlCookie model - junction table between PointUrl and Cookie
model PointUrlCookie {
  id             Int       @id @default(autoincrement())
  pointUrlId     Int       @map("point_url_id")
  cookieId       Int       @map("cookie_id")
  createdDate    DateTime  @default(now()) @map("created_date")
  modifiedDate   DateTime  @updatedAt @map("modified_date")
  createdBy      String?   @map("created_by")
  lastModifiedBy String?   @map("last_modified_by")

  pointUrl PointUrl @relation(fields: [pointUrlId], references: [id])
  cookie   Cookie   @relation(fields: [cookieId], references: [id], onDelete: Cascade)

  @@unique([pointUrlId, cookieId])
  @@map("point_url_cookie")
}

// PointUrlCallLog model - logs of point URL invocations
model PointUrlCallLog {
  id                 Int       @id @default(autoincrement())
  pointUrl           String    @map("point_url")
  siteName           String    @map("site_name")
  userName           String    @map("user_name")
  responseBody       String?   @map("response_body")
  responseHeader     String?   @map("response_header")
  cookie             String?
  responseStatusCode Int       @map("response_status_code")
  createdDate        DateTime  @default(now()) @map("created_date")
  modifiedDate       DateTime  @updatedAt @map("modified_date")
  createdBy          String?   @map("created_by")
  lastModifiedBy     String?   @map("last_modified_by")

  @@map("point_url_call_log")
}

// SavedPoint model - records of successfully earned points
model SavedPoint {
  id             Int       @id @default(autoincrement())
  cookieId       Int       @map("cookie_id")
  amount         Int
  responseBody   String?   @map("response_body")
  createdDate    DateTime  @default(now()) @map("created_date")
  modifiedDate   DateTime  @updatedAt @map("modified_date")
  createdBy      String?   @map("created_by")
  lastModifiedBy String?   @map("last_modified_by")

  cookie Cookie @relation(fields: [cookieId], references: [id], onDelete: Cascade)

  @@index([createdDate], map: "idx_saved_point_created")
  @@map("saved_point")
}
